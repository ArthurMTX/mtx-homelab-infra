services:
  metabase:
    image: metabase/metabase:v0.57.4.3
    container_name: metabase
    restart: always

    environment:
      MGID: "${GID-1000}"
      MB_DB_TYPE: postgres
      MB_DB_DBNAME: "{{ metabase_db_name }}"
      MB_DB_PORT: "{{ ports.database.tcp }}"
      MB_DB_USER: "{{ metabase_db_user }}"
      MB_DB_PASS: "{{ metabase_db_password }}"
      MB_DB_HOST: "pgsql"

    networks:
      - web

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.metabase.rule=Host(`{{ metabase_hostname }}`)"
      - "traefik.http.routers.metabase.entrypoints=websecure"
      - "traefik.http.routers.metabase.tls=true"
      - "traefik.http.routers.metabase.tls.certresolver=lets-encrypt"
      - "traefik.http.services.metabase.loadBalancer.server.port={{ ports.metabase.http }}"

networks:
  web:
    external: true
